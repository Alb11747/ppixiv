<!doctype html>
<body>

<script>

// This is similar to bootstrap.js, but for standalone launches.  This should probably
// be simplified.
let _load_source_file = function(__pixiv, __source) {
    const ppixiv = __pixiv;
    with(ppixiv)
    {
        return eval(__source);
    }
};

(async() =>
{
    console.log("ppixiv bootstrap");

    // In a development build, our source and binary assets are in @resources, and we need
    // to pull them out into an environment manually.
    let env = {};

    // Set ppixiv.native to true to let the UI know that we're in our native environment
    // and not running in Pixiv.
    env.native = true;

    env.resources = {};

    let result = await fetch("/client/init.js");
    let init = await result.json();

    // Fetch each source file.  Do this in parallel.
    let source_fetches = {};
    for(let path of init.source_files)
    {
        // Load the source file.
        source_fetches[path] = fetch(path);
    }

    for(let [path, url] of Object.entries(init.resources))
    {
        // Load the resource.
        source_fetches[path] = fetch(url);
    }

    // Wait for all fetches to complete.
    await Promise.all(Object.values(source_fetches));

    for(let [path, source_fetch] of Object.entries(source_fetches))
    {
        source_fetch = await source_fetch;
        let data = null;
        if(path.endsWith(".png"))
        {
            // Load binary resources into object URLs.
            data = await source_fetch.blob();
            if(data == null)
                continue
            data = URL.createObjectURL(data);
        }
        else
        {
            data = await source_fetch.text();
            if(data == null)
                continue

            // Add sourceURL to each file.  Remove the mtime query so it doesn't clutter logs.
            let url = new URL(source_fetch.url);
            url.search = "";

            data += "\n";
            data += `//# sourceURL=${url}\n`;
        }

        env.resources[path] = data;
    }

    // Load each source file.
    for(let path of init.source_files)
    {
        let source = env.resources[path];
        if(!source)
        {
            console.error("Source file missing:", path);
            continue;
        }

        _load_source_file(env, source);
    }

    window.unsafeWindow = window;
    window.ppixiv = env;

    // Create the main controller.
    env.main_controller.launch();
})();

</script>